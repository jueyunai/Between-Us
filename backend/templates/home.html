<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦–é¡µ - Between Us</title>
    <link rel="stylesheet" href="/static/css/common.css">
</head>
<body class="home-page">
    <div class="container home-shell">
        <header class="home-topbar">
            <div class="home-title">
                <div class="home-intro">ä»Šæ—¥ä¸»é¢˜ Â· æ¸©æŸ”ç–—æ„ˆ</div>
                <h1>ğŸ’ Between Us</h1>
                <p>è®©äº²å¯†å…³ç³»æ‹¥æœ‰æ›´æ¸…æ™°çš„è¡¨è¾¾æ–¹å¼ä¸è¢«ç†è§£çš„ç©ºé—´ã€‚</p>
            </div>
            <button class="avatar-btn" onclick="window.location.href='/profile'" aria-label="æ‰“å¼€ä¸ªäººä¸­å¿ƒ">æˆ‘</button>
        </header>

        <section class="entry-carousel">
            <div class="carousel-hint">å·¦å³æ»‘åŠ¨ï¼Œè¿›å…¥ä¸åŒç©ºé—´</div>
            <div class="card-track" id="cardTrack">
                <a href="/coach" class="entry-card entry-card-coach" data-role="coach" data-index="0" data-original="true">
                    <div class="entry-tag">éšæ—¶å¯ç”¨</div>
                    <div class="entry-head">
                        <div class="entry-icon">ğŸ’¬</div>
                        <div>
                            <div class="entry-title">ä¸ªäººæ•™ç»ƒ</div>
                            <div class="entry-subtitle">æŠŠæƒ…ç»ªæ¢³ç†æ¸…æ¥šï¼ŒæŠŠè¯è¯´åˆ°å¿ƒé‡Œ</div>
                        </div>
                    </div>
                    <p class="entry-desc">é€‚åˆç‹¬å¤„æ—¶çš„è‡ªæˆ‘å¯¹è¯ï¼Œæ¸©æŸ”é™ªä½ æ¢³ç†å½“ä¸‹çš„æ„Ÿå—ä¸éœ€æ±‚ã€‚</p>
                    <div class="entry-insight">
                        <div class="entry-insight-label">ä»Šæ—¥å»ºè®®</div>
                        <div class="entry-insight-text">å…ˆè¯´â€œæˆ‘ç°åœ¨çš„å¿ƒæƒ…æ˜¯â€¦â€ï¼Œå†è¯´â€œæˆ‘å¸Œæœ›ä½ èƒ½â€¦â€ã€‚</div>
                    </div>
                    <div class="entry-meta">
                        <div class="entry-meta-item">
                            <span class="meta-label">æ¨èæ—¶é•¿</span>
                            <span class="meta-value">3-5 åˆ†é’Ÿ</span>
                        </div>
                        <div class="entry-meta-item">
                            <span class="meta-label">é™ªä¼´æ–¹å¼</span>
                            <span class="meta-value">ä¸€å¯¹ä¸€å€¾å¬</span>
                        </div>
                    </div>
                    <div class="entry-tags">
                        <span>æƒ…ç»ªæ¢³ç†</span>
                        <span>è¡¨è¾¾ç»ƒä¹ </span>
                        <span>è½»è´Ÿæ‹…</span>
                    </div>
                    <div class="entry-action">å¼€å§‹å¯¹è¯ â†’</div>
                </a>

                <a href="/lounge" class="entry-card entry-card-lounge is-locked" data-role="lounge" data-index="1" data-original="true" aria-disabled="true">
                    <div class="entry-tag">åŒäººç©ºé—´</div>
                    <div class="entry-head">
                        <div class="entry-icon">ğŸ’‘</div>
                        <div>
                            <div class="entry-title">æƒ…æ„Ÿå®¢å…</div>
                            <div class="entry-subtitle">ä¸€èµ·è¯´æ¸…æ¥šï¼Œä¸€èµ·è¢«æ¸©æŸ”å›åº”</div>
                        </div>
                    </div>
                    <p class="entry-desc">é€‚åˆä¸¤ä¸ªäººçš„å¯¹è¯åœºæ™¯ï¼Œè®© AI å¸®ä½ ä»¬æ›´å¥½åœ°ç†è§£å½¼æ­¤ã€‚</p>
                    <div class="entry-insight">
                        <div class="entry-insight-label">æœ¬å‘¨å°ä»ªå¼</div>
                        <div class="entry-insight-text">è¯´ä¸€å¥â€œæˆ‘çœ‹è§ä½ ä»Šå¤©çš„åŠªåŠ›äº†â€ï¼Œå†å¬å¯¹æ–¹å›åº”ã€‚</div>
                    </div>
                    <div class="entry-meta">
                        <div class="entry-meta-item">
                            <span class="meta-label">æ¨èæ—¶é•¿</span>
                            <span class="meta-value">6-10 åˆ†é’Ÿ</span>
                        </div>
                        <div class="entry-meta-item">
                            <span class="meta-label">å…³ç³»æ¨¡å¼</span>
                            <span class="meta-value">åŒäººåä½œ</span>
                        </div>
                    </div>
                    <div class="entry-tags">
                        <span>å…±åŒè¡¨è¾¾</span>
                        <span>å…³ç³»ä¿®å¤</span>
                        <span>å®‰å…¨æ„Ÿ</span>
                    </div>
                    <div class="entry-action">è¿›å…¥é™ªä¼´ â†’</div>
                    <div class="entry-lock">
                        <div class="entry-lock-corner"></div>
                        <div class="entry-lock-corner-text">å¾…ç»‘å®š</div>
                    </div>
                </a>
            </div>
            <div class="carousel-dots">
                <button class="carousel-dot active" data-index="0" aria-label="åˆ‡æ¢åˆ°ä¸ªäººæ•™ç»ƒ"></button>
                <button class="carousel-dot" data-index="1" aria-label="åˆ‡æ¢åˆ°æƒ…æ„Ÿå®¢å…"></button>
            </div>
        </section>
    </div>

    <div class="home-shape home-shape-1" aria-hidden="true"></div>
    <div class="home-shape home-shape-2" aria-hidden="true"></div>
    <div class="home-shape home-shape-3" aria-hidden="true"></div>

    <div id="bindGuideModal" class="modal-overlay">
        <div class="modal-card modal-card-soft">
            <div class="modal-tag" id="bindGuideTag">æ¸©æŸ”æç¤º</div>
            <h2 class="modal-title" id="bindGuideTitle">ç»‘å®šåè§£é”æƒ…æ„Ÿå®¢å…</h2>
            <p class="modal-subtitle" id="bindGuideDesc">å…ˆå»ä¸ªäººä¸­å¿ƒå®Œæˆç»‘å®šï¼Œæˆ‘ä»¬ä¼šåœ¨æƒ…æ„Ÿå®¢å…ç­‰ä½ ä»¬ã€‚</p>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="goProfile()">å»ä¸ªäººä¸­å¿ƒ</button>
                <button class="btn btn-secondary" onclick="closeBindGuideModal()">ç¨åå†è¯´</button>
            </div>
        </div>
    </div>

    <script>
        const cardTrack = document.getElementById('cardTrack');
        const dots = Array.from(document.querySelectorAll('.carousel-dot'));
        let cards = [];
        let originalCards = [];
        let loungeCards = [];
        let cardSpacing = 0;
        let loopWidth = 0;
        let loopOffset = 0;
        let isJumping = false;
        let isInitialized = false;
        const guideModal = document.getElementById('bindGuideModal');
        const guideTitle = document.getElementById('bindGuideTitle');
        const guideDesc = document.getElementById('bindGuideDesc');
    
        let loungeState = 'binding';
    
        function updateTransforms() {
            if (!cardTrack || !isInitialized) return;
            const trackRect = cardTrack.getBoundingClientRect();
            const center = trackRect.left + trackRect.width / 2;
            let closestIndex = 0;
            let closestDist = Infinity;
    
            cards.forEach((card) => {
                const rect = card.getBoundingClientRect();
                const cardCenter = rect.left + rect.width / 2;
                const dist = (cardCenter - center) / rect.width;
                const rotate = Math.max(Math.min(dist * 16, 18), -18);
                const scale = 1 - Math.min(Math.abs(dist) * 0.08, 0.14);
                const opacity = 1 - Math.min(Math.abs(dist) * 0.22, 0.4);
                card.style.transform = `perspective(900px) rotateY(${rotate}deg) scale(${scale})`;
                card.style.opacity = opacity;
    
                if (Math.abs(cardCenter - center) < closestDist) {
                    closestDist = Math.abs(cardCenter - center);
                    closestIndex = Number(card.dataset.index || 0);
                }
            });
    
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === closestIndex);
            });
        }
    
        function scrollToCard(index, smooth = true) {
            const target = originalCards[index];
            if (!target) return;
            target.scrollIntoView({ 
                behavior: smooth ? 'smooth' : 'instant', 
                inline: 'center', 
                block: 'nearest' 
            });
        }
    
        dots.forEach((dot) => {
            dot.addEventListener('click', () => {
                const index = Number(dot.dataset.index || 0);
                scrollToCard(index);
            });
        });
    
        let scrollEndTimer = null;
        
        function normalizeScroll() {
            if (!loopWidth || isJumping || !loopOffset || !isInitialized) return;
            
            // ä½¿ç”¨é˜²æŠ–ï¼šåªåœ¨æ»šåŠ¨åœæ­¢åæ‰æ£€æµ‹æ˜¯å¦éœ€è¦è·³è½¬
            clearTimeout(scrollEndTimer);
            scrollEndTimer = setTimeout(() => {
                if (isJumping) return;
                
                const scrollLeft = cardTrack.scrollLeft;
                // è®¡ç®—å½“å‰åº”è¯¥åœ¨åŸå§‹å¡ç‰‡åŒºåŸŸçš„åˆç†èŒƒå›´
                // åŸå§‹å¡ç‰‡ä» loopOffset å¼€å§‹ï¼Œè·¨è¶Š loopWidth
                // åªæœ‰æ»šåŠ¨åˆ°å…‹éš†åŒºåŸŸï¼ˆè¶…å‡ºåŸå§‹åŒºåŸŸä¸€å¼ å¡ç‰‡ä»¥ä¸Šï¼‰æ‰è·³è½¬
                const minThreshold = loopOffset - cardSpacing * 0.8;
                const maxThreshold = loopOffset + loopWidth - cardSpacing * 0.2;
                
                if (scrollLeft < minThreshold) {
                    isJumping = true;
                    cardTrack.style.scrollSnapType = 'none';
                    cardTrack.style.scrollBehavior = 'auto';
                    cardTrack.scrollLeft = scrollLeft + loopWidth;
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            cardTrack.style.scrollSnapType = 'x mandatory';
                            cardTrack.style.scrollBehavior = 'smooth';
                            isJumping = false;
                        });
                    });
                } else if (scrollLeft > maxThreshold) {
                    isJumping = true;
                    cardTrack.style.scrollSnapType = 'none';
                    cardTrack.style.scrollBehavior = 'auto';
                    cardTrack.scrollLeft = scrollLeft - loopWidth;
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            cardTrack.style.scrollSnapType = 'x mandatory';
                            cardTrack.style.scrollBehavior = 'smooth';
                            isJumping = false;
                        });
                    });
                }
            }, 150); // æ»šåŠ¨åœæ­¢ 150ms åæ‰æ£€æµ‹
        }
    
        if (cardTrack) {
            cardTrack.addEventListener('scroll', () => {
                window.requestAnimationFrame(() => {
                    normalizeScroll();
                    updateTransforms();
                });
            });
        }
    
        window.addEventListener('resize', () => {
            measureCarousel();
            recalculateLoopOffset();
            updateTransforms();
        });
    
        function createClone(card) {
            const clone = card.cloneNode(true);
            clone.dataset.clone = 'true';
            clone.dataset.original = 'false';
            clone.setAttribute('aria-hidden', 'true');
            return clone;
        }
    
        function measureCarousel() {
            if (!cardTrack || !originalCards.length) return;
            const allCards = Array.from(cardTrack.querySelectorAll('.entry-card'));
            if (allCards.length > 1) {
                cardSpacing = allCards[1].offsetLeft - allCards[0].offsetLeft;
            } else if (allCards[0]) {
                cardSpacing = allCards[0].offsetWidth;
            }
            loopWidth = cardSpacing * originalCards.length;
        }
    
        function recalculateLoopOffset() {
            const firstOriginal = originalCards[0];
            if (firstOriginal && cardTrack) {
                const left = firstOriginal.offsetLeft - cardTrack.offsetLeft;
                const centerOffset = (cardTrack.clientWidth - firstOriginal.clientWidth) / 2;
                loopOffset = left - centerOffset;
            }
        }
    
        function setupInfiniteCarousel() {
            if (!cardTrack) return;
                
            // åˆå§‹åŒ–æœŸé—´ç¦ç”¨ scroll-snap é¿å…å†²çª
            cardTrack.style.scrollSnapType = 'none';
            cardTrack.style.scrollBehavior = 'auto';
                
            originalCards = Array.from(cardTrack.querySelectorAll('.entry-card[data-original="true"]'));
            if (!originalCards.length) {
                originalCards = Array.from(cardTrack.querySelectorAll('.entry-card'));
            }
            originalCards.forEach((card, idx) => {
                card.dataset.index = card.dataset.index || idx;
                card.dataset.original = 'true';
            });
    
            // å‰åå„å…‹éš† 2 ç»„
            const clones = 2;
            for (let i = 0; i < clones; i += 1) {
                const beforeClones = originalCards.map((card) => createClone(card));
                beforeClones.slice().reverse().forEach((clone) => {
                    cardTrack.prepend(clone);
                });
                const afterClones = originalCards.map((card) => createClone(card));
                afterClones.forEach((clone) => {
                    cardTrack.appendChild(clone);
                });
            }
    
            cards = Array.from(cardTrack.querySelectorAll('.entry-card'));
            loungeCards = Array.from(cardTrack.querySelectorAll('[data-role="lounge"]'));
                
            // ç­‰å¾… DOM æ¸²æŸ“å®Œæˆåå†æµ‹é‡å’Œå®šä½
            requestAnimationFrame(() => {
                measureCarousel();
                recalculateLoopOffset();
                    
                // å®šä½åˆ°ç¬¬ä¸€å¼ åŸå§‹å¡ç‰‡ï¼ˆä¸ªäººæ•™ç»ƒï¼‰
                cardTrack.scrollLeft = loopOffset;
                    
                // å†æ¬¡ç­‰å¾…ç¡®ä¿æ»šåŠ¨å®Œæˆ
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        // é‡æ–°å¯ç”¨ scroll-snap
                        cardTrack.style.scrollSnapType = 'x mandatory';
                        cardTrack.style.scrollBehavior = 'smooth';
                        isInitialized = true;
                        updateTransforms();
                    });
                });
            });
        }

        function showBindGuideModal(reason) {
            if (reason === 'cooldown') {
                guideTitle.textContent = 'å†·é™æœŸä¸­ï¼Œæš‚ä¸èƒ½è¿›å…¥æƒ…æ„Ÿå®¢å…';
                guideDesc.textContent = 'å¯åœ¨ä¸ªäººä¸­å¿ƒæŸ¥çœ‹å€’è®¡æ—¶ï¼Œå†·é™æœŸç»“æŸåå°†é‡æ–°å¼€æ”¾ã€‚';
            } else {
                guideTitle.textContent = 'ç»‘å®šåè§£é”æƒ…æ„Ÿå®¢å…';
                guideDesc.textContent = 'å…ˆå»ä¸ªäººä¸­å¿ƒå®Œæˆç»‘å®šï¼Œæˆ‘ä»¬ä¼šåœ¨æƒ…æ„Ÿå®¢å…ç­‰ä½ ä»¬ã€‚';
            }
            guideModal.style.display = 'flex';
        }

        function closeBindGuideModal() {
            guideModal.style.display = 'none';
        }

        function goProfile() {
            window.location.href = '/profile';
        }

        function setLoungeLocked(locked, reason) {
            loungeState = reason;
            if (!loungeCards.length) return;
            loungeCards.forEach((card) => {
                card.classList.toggle('is-locked', locked);
                card.setAttribute('aria-disabled', locked ? 'true' : 'false');
                const lockCornerText = card.querySelector('.entry-lock-corner-text');
                if (!lockCornerText) return;

                if (locked && reason === 'cooldown') {
                    lockCornerText.textContent = 'å†·é™ä¸­';
                } else if (locked) {
                    lockCornerText.textContent = 'å¾…ç»‘å®š';
                } else {
                    lockCornerText.textContent = '';
                }
            });
        }

        function bindLoungeHandlers() {
            if (!loungeCards.length) return;
            loungeCards.forEach((card) => {
                card.addEventListener('click', (event) => {
                    if (card.classList.contains('is-locked')) {
                        event.preventDefault();
                        showBindGuideModal(loungeState === 'cooldown' ? 'cooldown' : 'binding');
                    }
                });
            });
        }

        async function loadHomeState() {
            try {
                const response = await fetch('/api/user/info');
                const data = await response.json();
                if (!data.success) {
                    window.location.href = '/';
                    return;
                }

                const user = data.user;
                const isCoolingDown = Boolean(user.unbind_at);
                // å†·é™æœŸä¹Ÿå…è®¸è¿›å…¥æƒ…æ„Ÿå®¢å…ï¼Œåªæ˜¯æ˜¾ç¤ºæç¤º
                const canEnterLounge = user.has_partner;
                setLoungeLocked(!canEnterLounge, isCoolingDown ? 'cooldown' : 'binding');
            } catch (error) {
                console.error(error);
                window.location.href = '/';
            }
        }

        setupInfiniteCarousel();
        bindLoungeHandlers();
        loadHomeState();
    </script>
</body>
</html>

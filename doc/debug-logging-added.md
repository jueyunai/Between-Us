# 调试日志添加记录

**日期**: 2026-01-18  
**目的**: 排查魔搭Docker部署后个人教练页面无法收到AI回复的问题

## 添加的日志位置

### 1. 后端 API 日志 (`app.py`)

#### `/api/coach/chat/stream` 路由
- ✅ 请求开始/结束标记（带分隔线）
- ✅ 用户ID和消息内容
- ✅ 用户信息获取
- ✅ 数据库异步保存提交
- ✅ 历史对话读取（记录数量）
- ✅ API配置检查（COZE_API_KEY、BOT_ID）
- ✅ Coze API调用详情：
  - API URL、Bot ID、User ID
  - 消息数量
  - 响应状态码
  - API响应耗时
- ✅ 流式响应处理：
  - 行数统计（前5行和每10行打印）
  - 事件类型识别
  - 完成信号 [DONE]
  - 思考内容接收（长度）
  - 正文内容累计（每50字符打印）
  - 定期保存中间结果
  - 完成事件类型
- ✅ 最终保存：
  - 总行数
  - 最终内容长度
  - 思考内容长度
  - 数据库保存耗时
- ✅ 异常处理：
  - 异常类型和消息
  - 完整堆栈跟踪

### 2. 数据库操作日志 (`storage_sqlite.py`)

#### `CoachChat.save()` 方法
- ✅ 创建/更新操作标识
- ✅ 记录ID、role、内容长度
- ✅ 保存成功后的ID
- ✅ 保存耗时
- ✅ 异常捕获和堆栈跟踪

#### `CoachChat.filter()` 方法
- ✅ 查询条件
- ✅ 返回记录数
- ✅ 查询耗时

### 3. 前端日志 (`templates/coach.html`)

#### `loadHistory()` 函数
- ✅ 加载开始
- ✅ API响应状态
- ✅ 返回数据
- ✅ 加载的记录数量
- ✅ 错误捕获

#### `sendMessage()` 函数
- ✅ 发送开始（消息预览）
- ✅ 创建流式占位符
- ✅ API请求发起
- ✅ API响应状态和耗时
- ✅ 响应头信息
- ✅ 流式数据包计数（前5个和每10个打印）
- ✅ 思考内容开始/完成
- ✅ 完成信号和最终内容长度
- ✅ 总数据包统计
- ✅ 错误详情

## 日志格式规范

### 后端日志前缀
- `[Coach Stream]` - 个人教练流式接口
- `[DB]` - 数据库操作
- `[Coze API]` - Coze API调用

### 日志级别标识
- `✓` - 成功操作
- `❌` - 失败/错误
- 无标识 - 信息性日志

### 前端日志前缀
- `[Coach]` - 个人教练页面操作

## 使用方法

### 查看后端日志
```bash
# 魔搭平台
docker logs <container_id> | grep -E "\[Coach Stream\]|\[DB\]|\[Coze API\]"

# 或查看完整日志
docker logs -f <container_id>
```

### 查看前端日志
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 发送消息后查看日志输出

## 排查流程

1. **检查前端是否发起请求**
   - 查看浏览器控制台 `[Coach] 开始发送消息`
   - 查看 `[Coach] API响应状态`

2. **检查后端是否收到请求**
   - 查看服务器日志 `[Coach Stream] 收到流式聊天请求`
   - 确认用户ID和消息内容

3. **检查API配置**
   - 查看 `[Coach Stream] ✓ API配置检查通过`
   - 如果失败，检查环境变量

4. **检查Coze API调用**
   - 查看 `[Coach Stream] API响应状态码`
   - 查看 `[Coach Stream] API响应耗时`
   - 如果状态码非200，检查API密钥和Bot ID

5. **检查流式响应**
   - 查看 `[Coach Stream] 开始读取流式响应`
   - 查看行数统计和事件类型
   - 查看是否收到内容

6. **检查数据库保存**
   - 查看 `[DB] 创建教练聊天记录`
   - 查看 `[DB] ✓ 教练聊天记录保存成功`

7. **检查前端接收**
   - 查看浏览器控制台数据包计数
   - 查看 `[Coach] 收到完成信号`
   - 查看最终内容长度

## 常见问题定位

### 问题1：前端无日志
- **原因**: 页面未加载或JS错误
- **排查**: 检查浏览器控制台是否有JS错误

### 问题2：后端无日志
- **原因**: 请求未到达后端或日志未输出
- **排查**: 检查网络连接、反向代理配置

### 问题3：API响应超时
- **原因**: Coze API调用超时
- **排查**: 检查网络连接、API密钥、Bot配置

### 问题4：流式响应无数据
- **原因**: 反向代理缓冲、SSE不支持
- **排查**: 检查Nginx配置、考虑降级到非流式接口

### 问题5：数据库保存失败
- **原因**: 数据库锁、权限问题
- **排查**: 检查数据库文件权限、磁盘空间

## 下一步

根据日志输出结果，可以：
1. 确认具体失败环节
2. 添加降级方案（流式→非流式）
3. 优化超时配置
4. 调整反向代理设置

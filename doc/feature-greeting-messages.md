# 功能：开场白随机显示（最终方案）

## 需求背景
用户首次进入个人教练或情感客厅时，希望看到温暖的开场白，增强用户体验和情感连接。

## 实现方案（v2 - 数据库方案）

### 方案演进
- **v1（已废弃）**：通过流式响应发送 `greeting` 事件，需要前端特殊处理
- **v2（当前）**：注册/绑定时直接写入数据库，作为普通 AI 消息，前端无需改动

### 核心逻辑
1. **用户注册时**：自动创建一条个人教练开场白消息（随机选择）
2. **伴侣绑定时**：自动创建一条情感客厅开场白消息（随机选择）
3. 开场白作为普通 AI 消息存储在数据库中，用户首次进入即可看到

### 开场白内容

#### 💬 个人教练开场白（3选1随机）
1. **温暖陪伴型**：嗨，我在这里呢。无论发生了什么，你都可以跟我说。我会站在你这边，也会帮你看得更清楚一些。❤️
2. **引导倾诉型**：此刻的你，心里有什么感受想说说吗？不用担心说得好不好，我会认真听的。💭
3. **轻松友好型**：来啦！就像跟老朋友聊天一样，有什么想说的尽管说～我既是你的树洞，也是你的镜子。🌟

#### 💝 情感客厅开场白（3选1随机）
1. **仪式感强**：欢迎来到你们的情感客厅。这里是专属于你们两个人的安全空间，我会在需要时出现，陪你们好好聊聊。💕
2. **引导对话型**：很高兴见到你们。在这里，你们可以坦诚地说出自己的感受。如果需要我帮忙梳理，随时@我就好。🤝
3. **轻量温暖型**：这里是属于你们的小天地。有我在，你们可以放心地说出心里话。需要帮忙时，@我一下就好～💫

## 技术实现

### 新增函数
```python
def create_coach_greeting(user_id):
    """为新用户创建个人教练开场白"""
    
def create_lounge_greeting(room_id):
    """为新房间创建情感客厅开场白"""
```

### 调用时机
- `/api/register`：用户注册成功后调用 `create_coach_greeting()`
- `/api/binding/bind`：伴侣绑定成功后调用 `create_lounge_greeting()`

### 数据库存储
- **coach_chats 表**：`role='assistant'`, `content=开场白内容`
- **lounge_chats 表**：`role='assistant'`, `user_id=NULL`, `content=开场白内容`

## 修改文件
- `storage_sqlite.py`：
  - 在 `init_db()` 函数中添加 `_auto_migrate_greetings()` 调用
  - 新增 `_auto_migrate_greetings()` 函数，自动补充历史用户开场白
- `app.py`：
  - 新增 `create_coach_greeting()` 和 `create_lounge_greeting()` 函数
  - 修改 `/api/register` 接口，注册后创建开场白
  - 修改 `/api/binding/bind` 接口，绑定后创建开场白

## 旧用户数据迁移

### 自动迁移机制
在 `storage_sqlite.py` 的 `init_db()` 函数中集成了自动补充开场白的逻辑：

```python
def _auto_migrate_greetings(cursor):
    """自动为历史用户补充开场白（在 init_db 中调用）"""
```

### 执行时机
- 每次应用启动时自动执行
- 在数据库初始化完成后调用
- 智能判断，不会重复创建

### 迁移逻辑
1. **个人教练**：
   - 如果用户没有任何聊天记录，创建开场白（时间戳=用户创建时间）
   - 如果用户第一条消息是用户消息，在前面插入开场白（时间戳=用户创建时间）
   - 如果用户第一条消息已经是 AI 消息，跳过（认为已有开场白）

2. **情感客厅**：
   - 如果房间没有任何消息，创建开场白（时间戳=房间创建时间）
   - 如果房间第一条消息是用户消息，在前面插入开场白（时间戳=房间创建时间）
   - 如果房间第一条消息已经是 AI 消息，跳过（认为已有开场白）

### 幂等性保证
- 多次启动不会重复创建开场白
- 已有开场白的用户/房间会自动跳过
- 只在需要时才输出日志信息

### 测试验证
✅ 清理数据后重新导入模块，成功补充 6 个用户和 3 个房间的开场白
✅ 再次导入模块，不会重复创建
✅ 所有用户第一条消息都是 AI 开场白
✅ 所有房间第一条消息都是 AI 开场白

## 优势
1. ✅ **前端零改动**：开场白作为普通消息，前端无需特殊处理
2. ✅ **持久化存储**：刷新页面后仍能看到开场白
3. ✅ **逻辑简单**：注册/绑定时一次性创建，无需运行时判断
4. ✅ **用户体验好**：首次进入就能看到温暖的欢迎消息
5. ✅ **自动迁移**：应用启动时自动为历史用户补充开场白
6. ✅ **幂等性保证**：多次启动不会重复创建

## 测试要点
1. 新用户注册后，进入个人教练应看到随机开场白
2. 新用户绑定伴侣后，进入情感客厅应看到随机开场白
3. 开场白作为第一条消息显示在聊天记录中
4. 每个用户/房间的开场白是随机的（3选1）

## 版本信息
- 实施日期：2026-01-18
- 方案版本：v2（数据库方案）
- 影响范围：用户注册、伴侣绑定
- 向后兼容：是（已为旧用户补充开场白）
- 前端改动：无


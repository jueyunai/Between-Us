# 情感客厅 - AI 分析提示同步显示

## 问题描述
当一个用户@教练触发AI分析时，只有发送消息的用户能看到"情感教练正在分析..."提示，另一个用户看不到这个提示。

## 解决方案
通过 WebSocket 广播机制，让后端在开始AI分析时向房间内所有用户广播"开始分析"事件。

### 后端修改 (app.py)
在 `handle_call_ai` 函数开始处添加广播事件：
```python
@socketio.on('call_ai')
def handle_call_ai(data):
    room_id = data.get('room_id')
    
    # 先向房间广播"开始分析"事件，让所有用户都看到提示
    emit('ai_thinking_start', {}, room=room_id)
    
    # ... 后续AI调用逻辑
```

### 前端修改 (templates/lounge.html)
1. 添加 `ai_thinking_start` 事件监听器，所有用户都会收到并显示提示
2. 简化 `callAI()` 函数，移除本地创建占位消息的逻辑
3. 保留 `ai_stream` 中的防御性检查，确保即使网络延迟也能正常显示

## 效果
- 用户A @教练发送消息
- 后端广播 `ai_thinking_start` 事件
- 用户A和用户B同时看到"🎯 情感教练正在分析..."
- AI流式输出时，两个用户同步看到内容更新

---

## AI 消息格式优化

### 问题
AI 输出内容太长且没有段落样式，阅读体验差。

### 解决方案
1. 增加行高到 1.7，提升可读性
2. 保留换行符 (`white-space: pre-wrap`)
3. 支持基本 Markdown 格式：
   - **加粗标题**（带颜色）
   - **加粗文本**
   - *斜体文本*

### 效果
AI 消息自动分段，层次清晰，易于阅读。

---

## 冷静期优化

### 问题
冷静期内用户无法进入情感客厅，体验不友好。

### 解决方案
**允许冷静期进入情感客厅**，但显示温馨提示。

#### 修改内容

**1. home.html**
- 移除冷静期的锁定检查
- 改为：`const canEnterLounge = user.has_partner;`（只要有伴侣就能进入）
- 保留"冷静中"视觉标签

**2. lounge.html**
- 添加冷静期提示条（黄色渐变背景）
- 提示文案："冷静期中，仍可正常使用客厅。如需撤销解绑，前往个人中心 →"
- 根据用户的 `unbind_at` 字段动态显示/隐藏提示条

### 效果
- 冷静期用户可以正常进入情感客厅聊天
- 顶部显示温馨提示，引导用户去个人中心撤销解绑
- 不影响正常用户的使用体验

## 修改日期
2026-01-18

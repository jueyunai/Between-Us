# 部署魔搭 Docker 修改清单

**日期**: 2026-01-18  
**结论**: 基本无需修改，只需更新文档和配置

## ✅ 已完成的修改

### 1. README.md
- ✅ 更新数据库描述：Supabase → SQLite
- ✅ 更新环境要求：移除 Supabase 账号要求

### 2. ms_deploy.json
- ✅ 移除 Supabase 相关环境变量（SUPABASE_URL, SUPABASE_KEY）
- ✅ 添加 FLASK_ENV=production
- ✅ 保留 Coze API 配置

### 3. 新增文档
- ✅ `doc/modelscope-sqlite-deployment.md` - 完整的魔搭部署指南

## 🎯 无需修改的部分

### 代码层面
- ✅ `app.py` - 已使用 SQLite，监听 0.0.0.0:7860
- ✅ `storage_sqlite.py` - 数据库路径已配置为 `/mnt/workspace/emotion_helper.db`
- ✅ `Dockerfile` - 端口、启动命令都正确
- ✅ `requirements.txt` - 依赖完整

### 配置层面
- ✅ README.md 元数据 - 已包含魔搭所需的 YAML front matter
- ✅ 端口配置 - 7860（魔搭标准端口）
- ✅ 数据持久化 - `/mnt/workspace/` 目录

## 📋 部署前检查

### 1. 环境变量（在魔搭创空间设置）
```bash
COZE_API_KEY=你的实际Key
COZE_BOT_ID_COACH=7595750315371413544
COZE_BOT_ID_LOUNGE=7596155063970758699
FLASK_ENV=production
```

### 2. 文件检查
- [x] `app.py` 第 4 行：`from storage_sqlite import ...`
- [x] `Dockerfile` 暴露 7860 端口
- [x] `README.md` 包含 `sdk: docker` 和 `app_port: 7860`
- [x] `ms_deploy.json` 配置正确

### 3. 功能验证
启动后测试：
- [ ] 用户注册/登录
- [ ] 个人教练聊天（流式输出）
- [ ] 情感客厅 WebSocket
- [ ] 伴侣绑定
- [ ] 数据持久化（重启后数据保留）

## 🚀 部署步骤

### 快速部署
1. 上传代码到魔搭创空间
2. 配置 4 个环境变量
3. 点击"重启空间"
4. 等待 3-5 分钟构建完成
5. 访问生成的 URL

### 详细步骤
参考 `doc/modelscope-sqlite-deployment.md`

## ⚠️ 重要提示

1. **数据持久化**
   - 数据存储在 `/mnt/workspace/emotion_helper.db`
   - Docker 重启后数据保留
   - 创空间转移/重命名时数据会丢失，需提前备份

2. **API Key 安全**
   - `ms_deploy.json` 中的 Key 仅用于配置参考
   - 实际部署时在魔搭 Web 界面配置环境变量
   - 不要将真实 Key 提交到公开仓库

3. **并发限制**
   - SQLite 适合中小规模应用（< 1000 并发）
   - 如需更高并发，考虑迁移到 PostgreSQL

## 📊 部署后验证

### 查看启动日志
应该看到：
```
============================================================
[启动] 使用 SQLite 本地数据库
[启动] 数据库路径: /mnt/workspace/emotion_helper.db
============================================================
[SQLite] 数据库初始化完成: /mnt/workspace/emotion_helper.db
```

### 性能指标
```
[DB Perf] 异步保存耗时: 0.003s  # 应该 < 0.1s
```

## 🎉 总结

**好消息**: 你的代码已经完全适配魔搭 Docker 部署！

**需要做的**:
1. ✅ 已更新 README.md 和 ms_deploy.json
2. ⏭️ 上传代码到魔搭创空间
3. ⏭️ 配置环境变量
4. ⏭️ 启动并测试

**无需修改**:
- 代码逻辑
- Dockerfile
- 数据库配置
- 端口配置

直接部署即可！🚀

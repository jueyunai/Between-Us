# 魔搭部署检查清单

## 部署前准备

### 1. 环境变量配置 ✅
确保 `ms_deploy.json` 中配置了以下环境变量：

```json
{
  "environment_variables": [
    {"name": "COZE_API_KEY", "value": "your-key"},
    {"name": "COZE_BOT_ID_COACH", "value": "your-bot-id"},
    {"name": "COZE_BOT_ID_LOUNGE", "value": "your-bot-id"},
    {"name": "SUPABASE_URL", "value": "https://xxx.supabase.co"},
    {"name": "SUPABASE_KEY", "value": "your-anon-key"}
  ]
}
```

### 2. 依赖检查 ✅
确保 `requirements.txt` 包含所有依赖：
- ✅ Flask
- ✅ flask-cors
- ✅ flask-socketio
- ✅ supabase
- ✅ python-dotenv
- ✅ requests

### 3. Dockerfile 优化 ✅
- ✅ 使用分层构建
- ✅ 设置生产环境变量
- ✅ 暴露正确端口（7860）

### 4. 代码优化 ✅
- ✅ 异步数据库写入
- ✅ 边流式边保存
- ✅ 网络延迟监控
- ✅ 性能日志记录

## 部署后验证

### 1. 启动检查
查看日志，确认以下信息：
```
[启动检测] 正在测试 Supabase 连接...
[正常] Supabase 延迟: 0.xxx s
```

如果看到警告：
```
[警告] Supabase 延迟较高: x.xxxs，建议检查网络
```
说明网络延迟较高，但不影响功能。

### 2. 功能测试

#### 用户注册/登录
- [ ] 注册新用户
- [ ] 登录已有用户
- [ ] 查看个人信息

#### 个人教练
- [ ] 发送消息
- [ ] 查看流式输出（思考过程 + 正文）
- [ ] 检查历史记录是否保存

#### 情感客厅
- [ ] 绑定伴侣
- [ ] 发送消息
- [ ] 召唤 AI
- [ ] 查看历史记录

### 3. 性能测试

运行性能测试脚本：
```bash
python test_performance.py
```

**预期结果**：
- 网络延迟：< 1s（理想）或 < 2s（可接受）
- 数据库查询：< 0.5s
- 数据库写入：< 0.5s

### 4. 数据完整性检查

#### 检查 AI 回复是否保存
1. 发送消息到个人教练
2. 等待 AI 回复完成
3. 刷新页面，检查历史记录
4. 确认 AI 回复内容完整

#### 检查流式中断恢复
1. 发送消息
2. 在流式输出过程中刷新页面
3. 检查数据库是否保存了部分内容（边流式边保存）

## 常见问题排查

### 问题 1：AI 回复延迟高
**症状**：用户发送消息后，等待时间长

**可能原因**：
1. Supabase 网络延迟高
2. Coze API 响应慢

**排查步骤**：
1. 查看启动日志中的 Supabase 延迟
2. 查看运行日志中的 `[DB Perf]` 记录
3. 查看 `[Coze API]` 日志

**解决方案**：
- 如果是 Supabase 延迟：已通过异步保存优化
- 如果是 Coze API 延迟：无法优化，等待 API 响应

### 问题 2：AI 回复未保存
**症状**：前端显示了 AI 回复，但刷新后消失

**可能原因**：
1. 流式输出中断
2. 数据库写入失败

**排查步骤**：
1. 查看日志中的 `[Async Save Error]`
2. 查看日志中的 `[Coach Stream] 最终保存内容长度`

**解决方案**：
- 已通过"边流式边保存"优化
- 即使流式中断，也会保存部分内容

### 问题 3：数据库连接失败
**症状**：启动时显示 `[Network] Supabase 连接失败`

**可能原因**：
1. 环境变量未配置
2. Supabase URL 或 Key 错误
3. 网络不通

**排查步骤**：
1. 检查 `ms_deploy.json` 中的环境变量
2. 在魔搭控制台查看环境变量是否正确注入
3. 测试网络连通性

**解决方案**：
- 修正环境变量配置
- 重新部署

## 性能监控

### 关键日志
部署后持续关注以下日志：

```
[DB Perf] 异步保存耗时: 0.xxxs
[Coach Stream] 最终保存内容长度: xxx
[Lounge Stream] 最终保存内容长度: xxx
[Async Save Error] xxx  # 如果出现，需要关注
```

### 性能指标
- **数据库写入**：< 0.5s 正常，> 1s 需要关注
- **AI 回复保存**：100% 成功率
- **流式输出**：流畅无卡顿

## 回滚方案

如果优化后出现问题，可以回滚到优化前版本：

1. 恢复 `app.py` 到优化前版本
2. 移除异步保存逻辑
3. 恢复同步保存方式

**注意**：回滚后会恢复原有的延迟问题。

## 下一步优化

如果性能仍不理想，可考虑：

1. **批量写入**：累积多条消息后批量提交
2. **本地缓存**：先写 SQLite，定期同步
3. **数据库索引**：优化查询性能
4. **CDN 加速**：使用 Supabase CDN

详见：`doc/supabase-performance-optimization.md`

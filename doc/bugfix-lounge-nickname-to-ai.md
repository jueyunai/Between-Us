# 修复：客厅传给扣子的用户标识使用昵称

**日期**: 2026-01-18  
**类型**: Bug修复

## 问题描述

情感客厅调用扣子AI时，传递给AI的用户标识使用的是**手机号后4位**（如 "1234"），而不是用户设置的**昵称**（如 "志云"、"我亦偏执久"）。

### 影响

扣子AI看到的对话内容是：
```
1234：为什么我每个信息会发两遍
5678：还有这个h5，退出去再进来都需要重新登陆
```

而不是更友好的：
```
志云：为什么我每个信息会发两遍
我亦偏执久：还有这个h5，退出去再进来都需要重新登陆
```

这会导致AI的回复不够个性化，无法使用用户的真实昵称。

## 根本原因

在 `app.py` 中，构建用户映射时直接使用了手机号后4位：

```python
# 错误的代码
user_map = {
    user1.id: user1.phone[-4:] if user1.phone else "用户1",
    user2.id: user2.phone[-4:] if user2.phone else "用户2"
}
```

## 解决方案

修改用户映射逻辑，**优先使用昵称，没有昵称时才使用手机号后4位**：

```python
# 修复后的代码
user_map = {
    user1.id: user1.nickname or (user1.phone[-4:] if user1.phone else "用户1"),
    user2.id: user2.nickname or (user2.phone[-4:] if user2.phone else "用户2")
}
```

### 修复位置

1. **流式版本**（正在使用）：`/api/lounge/call_ai/stream` - 第 1086-1089 行
2. **非流式版本**（未使用，但保持一致）：`/api/lounge/call_ai` - 第 971-974 行

## 相关文件

- `app.py` - 修复两个版本的客厅AI调用

## 测试验证

1. 确保用户已设置昵称（在个人中心）
2. 在情感客厅发送消息并 @教练
3. 查看后端日志，确认传给扣子的内容使用了昵称
4. AI回复应该能够使用用户的真实昵称

## 注意事项

- 如果用户没有设置昵称，会自动降级使用手机号后4位
- 前端目前只使用流式版本 `/api/lounge/call_ai/stream`
- 非流式版本已同步修复，保持代码一致性
